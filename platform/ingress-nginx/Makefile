# Default target
.DEFAULT_GOAL := help

# Variables
DEFAULT_VERSION := v1.10.1
VERSION ?= $(DEFAULT_VERSION)
BASE_URL := https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-$(VERSION)/deploy/static/provider/do/deploy.yaml
OUTPUT_YAML := base/deploy.yaml
TEMP_FILE := $(OUTPUT_YAML).tmp
REQUIRED_TOOLS := curl rm cat

# Phony targets
.PHONY: update clean help check-tools

# Target: check-tools
# Description: Ensure all required tools are available
check-tools:
	@echo "Checking required tools..."
	@missing_tools=; \
	for tool in $(REQUIRED_TOOLS); do \
		if ! command -v $$tool >/dev/null 2>&1; then \
			echo "Error: Required tool '$$tool' is not installed."; \
			missing_tools=1; \
		fi; \
	done; \
	if [ -n "$$missing_tools" ]; then \
		echo "Please install the missing tools and try again."; \
		exit 1; \
	fi
	@echo "All required tools are available."

# Target: update
# Description: Pull the specified version of YAML from GitHub and save it to OUTPUT_YAML
update: check-tools
	@echo "Starting update process..."
	@echo "Removing previous $(OUTPUT_YAML)..."
	@mkdir -p $(dir $(OUTPUT_YAML))
	@rm -f $(OUTPUT_YAML)

	@if [ -z "$(VERSION)" ]; then \
		echo "No VERSION argument provided, using default version: $(DEFAULT_VERSION)"; \
		VERSION=$(DEFAULT_VERSION); \
	fi

	@echo "Pulling YAML (Version: $(VERSION)) from GitHub..."
	@curl -fSL $(BASE_URL) -o $(TEMP_FILE) || { \
		echo "Error: Failed to download YAML from $(BASE_URL)"; \
		exit 1; \
	}

	@echo "# This file was autogenerated from $(BASE_URL)" > $(OUTPUT_YAML)
	@cat $(TEMP_FILE) >> $(OUTPUT_YAML)
	@rm -f $(TEMP_FILE)
	@echo "Update completed successfully. YAML saved to $(OUTPUT_YAML)."

# Target: clean
# Description: Remove the generated YAML file
clean:
	@echo "Cleaning up generated files..."
	@rm -f $(OUTPUT_YAML)
	@echo "Cleanup completed."

# Target: help
# Description: Display usage information
help:
	@echo "Makefile for managing application YAML"
	@echo ""
	@echo "Targets:"
	@echo "  check-tools : Ensure all required tools are available"
	@echo "  update      : Pull the specified version of Argo CD YAML from GitHub"
	@echo "  clean       : Remove the generated YAML file"
	@echo "  help        : Display this help message"
